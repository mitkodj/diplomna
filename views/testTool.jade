script(type='text/javascript' src='http://code.jquery.com/jquery.min.js')
link(rel='stylesheet', href='/stylesheets/style.css')
script(src='/socket.io/socket.io.js')
script.
	var socket = io("http://localhost:3010");
	var dataCollection = [];
	socket.on('newData', function (data) {
	
		console.log("lol",data);
		var resultTable = document.getElementById('testResultsTable');
					
		resultTable.innerHTML = "<tr><th>Потребител</th><th>IP адрес</th><th>Заявка</th><th>Статус на изпращача</th><th>Резултат</th></tr>";

		console.log(data, typeof data);
		var response = data;

		dataCollection.push(response);

		if (dataCollection.length > 30) {
			dataCollection.shift();
		}
		
		for(var i = dataCollection.length - 1; i >= 0; i--){
			var tableRow = "",
				td = "";

				if (dataCollection[i].rating == 1) {
					if (dataCollection[i].result == "Blind SQL Injection Anomaly Detected.") {
						td = "</td><td class='redAlert'>";
					} else {
						td = "</td><td class='yellowAlert'>";
					}
				} else {
					td = "</td><td class='greenAlert'>";
				}
				tableRow += "<tr>" + td;
				tableRow +=
				dataCollection[i].username +
				"</td>" + td +
				dataCollection[i].IP +
				"</td>" +  td +
				dataCollection[i].query +
				"</td>" + td + 
				dataCollection[i].rating +
				"</td>" + td + 
				dataCollection[i].result + "</td></tr>";
			$('#testResultsTable').append(tableRow);
		}

		socket.emit('my other event', { my: 'data' });
		});
	$(document).ready(function() {
		$("input[name=testButton]").click( function() {
		$.ajax( {
				type: "GET",
				url: '/testTool/test',
				dataType : "json",
				success: function( response ) {
					var resultTable = document.getElementById('testResultsTable');
					
					resultTable.innerHTML = "<tr><th>Потребител</th><th>IP адрес</th><th>Заявка</th><th>Статус на изпращача</th><th>Резултат</th></tr>";

					console.log(response, typeof response);
					for(var i = 0; i< response.length; i++){
						var tableRow = "",
							td = "";

							if (response[i].rating == 1) {
								if (response[i].result == "Blind SQL Injection Anomaly Detected.") {
									td = "</td><td class='redAlert'>";
								} else {
									td = "</td><td class='yellowAlert'>";
								}
							} else {
								td = "</td><td class='greenAlert'>";
							}
							tableRow += "<tr>" + td;
							tableRow +=
							response[i].username +
							"</td>" + td +
							response[i].IP +
							"</td>" +  td +
							response[i].query +
							"</td>" + td + 
							response[i].rating +
							"</td>" + td + 
							response[i].result + "</td></tr>";
						$('#testResultsTable').append(tableRow);
					}
				},
				error: function(err) {
					console.log("ERRor");
					var resultTable = document.getElementById('testResultsTable');
					
					resultTable.innerHTML = "<tr><th>Потребител</th><th>IP адрес</th><th>Заявка</th><th>Статус на изпращача</th><th>Резултат</th></tr>";
					alert("SQL Injection");
				}
			});
		} );

		$("input[name=configButton]").click( function() {
			document.location = "config";
		} );
		})
//- script(type='text/javascript' src='http://code.jquery.com/jquery.min.js')
//- script(src='/socket.io/socket.io.js')
block content
	h1 Welcome to Security Traffic Analyzer
	p If you want to start analyzing netword traffic to the server, click Track. In case you want to stap it click Untrack. If you want to add more patterns to the list of anomaly patterns you can do it through the config interface by clicking Edit Config.
div(name="IBANSearch", method="post")
	input(type="button", name="testButton", value="Track")
	input(type="button", name="configButton", value="Edit Config")
table(id="testResultsTable")
	tr
		th Потребител
		th IP адрес
		th Заявка
		th Статус на изпращача
		th Резултат